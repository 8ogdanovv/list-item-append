define(['jquery','Idus_Core/js/idus','Idus_Core/js/url','Magento_Ui/js/modal/modal','Idus_Core/js/slick.min','Magento_Catalog/product/view/validation','catalogAddToCart','domReady!'],function($,idus,url,modal,slick){'use strict';$.widget('idus.categoryFilter',{options:{filter:{filters:'#narrow-by-list, .category-single-filter',filter_item:'.filter-options-item',products_list:'.product-items',click:'.swatch-attribute li.item.attribute a',sort:'#sorter',action:'replace',loading_filter:'.idus_loader_page'},scroll:{container:'.product-items',item:'li.product-item',next_wrapper:'.load_next_wrapper',next:'.load_next a.next',prev_wrapper:'.load_prev_wrapper',previous:'.load_prev a.prev',loading_prev:'.page-loader.prev',loading_next:'.page-loader.next',action:'append'},filterApply:'.products-list-filter-apply',filterClear:'.products-list-filter-clear',filterToggle:'.products-list-filter-toggle-open',isLoading:false,ajaxCall:false},state:'ready',getInitialState:function(){return this.state;},setInitialState:function(val){this.state=val;},_create:function(){var self=this;this._bind();window.filterApplyTimeout=false;self._initSingleFilter();$(self.options.filter.sort).toggleClass('active',!!$(self.options.filter.sort).prop('selectedIndex'));$(self.options.filter.sort).off('change').on('change',function(){self.setSelectDymaicWidth(this);self.filterButton();if(self.isOpenNav()){self.toggleSelected($(this));return false;}else{var ajaxUrl=url.removeParamUrl(url.getWindowUrl(),'product_list_order');ajaxUrl=ajaxUrl+url.urlQuerySymb(ajaxUrl)+'product_list_order='+$(this).val();self.categoryFilter(ajaxUrl,self.options.filter,$(this));$(this).toggleClass('active',!!$(this).prop('selectedIndex'));}});$(document).on('idus-filterEmulation',function(e,el){var linkHref=$(el).attr('href');var parentSlide=$(el).closest('.idus-slider-slide');var selectedSlides=$('.filter-selected',$(el).closest('.idus-slider'));selectedSlides.not(parentSlide).removeClass('filter-selected');if(parentSlide.hasClass('filter-selected')){linkHref='';parentSlide.removeClass('filter-selected');}else{parentSlide.addClass('filter-selected');}
self.filterApply(linkHref);});$('body').on('click',self.options.filter.click,function(e){var ajaxUrl=$(this).attr('href');if($(this).closest('.filter_cat').length||ajaxUrl=='javascript:void(0);')return;e.preventDefault();self.toggleSelected($(this));self.filterApplyInit(e);$(document).trigger('idus-filterApply',[e.target]);});$('body').on('click',self.options.filterApply+':not(.disabled)',function(e){self.filterApply();if($('#products-list-filter-toggle').prop('checked')===true)$('#products-list-filter-toggle').prop('checked',false).trigger('change');$(document.body).removeClass('filters-open');});$('body').on('click',self.options.scroll.prev_wrapper+' a.prev',function(e){if(window.filterApplyTimeout)clearTimeout(window.filterApplyTimeout);e.preventDefault();var ajaxUrl=$(this).attr('href');$(this).hide();self.options.scroll.action='prepend';self.options.loading=self.options.scroll.loading_prev;self.options.scroll.actionUrl=false;self.categoryFilter(ajaxUrl,self.options.scroll,$(self.options.scroll.prev_wrapper));});$('body').on('click',self.options.scroll.next_wrapper+' a.next',function(e){if(window.filterApplyTimeout)clearTimeout(window.filterApplyTimeout);e.preventDefault();var ajaxUrl=$(this).attr('href');$(this).hide();self.options.scroll.action='append';self.options.loading=self.options.scroll.loading_next;self.options.scroll.actionUrl=true;self.categoryFilter(ajaxUrl,self.options.scroll,$(self.options.scroll.next_wrapper));});$('body').on('click',self.options.filterClear+':not(.disabled)',function(e){if(window.filterApplyTimeout)clearTimeout(window.filterApplyTimeout);var ajaxUrl=url.getWindowUrl('?');var baseurl=new URL(ajaxUrl[0]);var query=url.getParamUrl('q');if(query!=undefined&&query!='')ajaxUrl[0]+='?q='+query;self.options.loading=self.options.filter.loading_filter;$('.attribute.selected .multifilter_action, .attribute.selected .swatch-option, .attribute.selected').removeClass('selected');self.priceSlider(true);self.filterButton();self.categoryFilter(ajaxUrl[0],self.options.filter,$(self.options.filter.click));if($('#products-list-filter-toggle').prop('checked')===true)$('#products-list-filter-toggle').prop('checked',false).trigger('change');$(document.body).removeClass('filters-open');});$('body').on('click',function(e){if(!$(e.target).closest($('.filter-options-item.selected')).length){$('.filter-options-title','.filter-options-item.selected').click();}});$('body').on('keyup',function(e){if(e.key==='Escape')$('.filter-options-title','.filter-options-item.selected').click();});if($('.products-list-filter-toggle-open.selected').length){this.setInitialState('filtered');}
self.setSelectDymaicWidth($(self.options.filter.sort).get(0));},filterButton:function(){var self=this;if($('.price_filter').attr('change')||$('.filter-options-item:not([data-filter="cat"]) .item.selected',$(self.options.filter.filters)).length){$(self.options.filterToggle).addClass('selected');$(self.options.filterApply+','+self.options.filterClear).prop('disabled',false).removeClass('disabled');}else{$(self.options.filterToggle).removeClass('selected');if(this.getInitialState()!=='filtered'){$(self.options.filterApply+','+self.options.filterClear).prop('disabled',true).addClass('disabled');}}},filterApplyInit:function(e){var self=this;if(e!=undefined&&$(e.target).closest('.category-single-filter').length){self.filterApply();}
if(self.isOpenNav()){self.filterButton();}else{if(window.filterApplyTimeout)clearTimeout(window.filterApplyTimeout);window.filterApplyTimeout=setTimeout(function(){self.filterApply();},1000);}},filterApply:function(filterUrl){var self=this;self.options.loading=self.options.filter.loading_filter;if($('#products-list-filter-toggle').prop('checked')===true)$('#products-list-filter-toggle').prop('checked',false).trigger('change');if(filterUrl||filterUrl===''){var ajaxUrl=url.getWindowUrl('?')[0]+filterUrl;self.categoryFilter(ajaxUrl,self.options.filter);return;}
var arrUrl={};var product_list_order=url.getParamUrl('product_list_order');if(product_list_order!=undefined&&product_list_order!=''){arrUrl['product_list_order']={};arrUrl['product_list_order'][product_list_order]=product_list_order;}
$('.item.selected:not(.cloned)',$(self.options.filter.filters)).each(function(){var key=$(this).closest(self.options.filter.filter_item).attr('data-filter');var id=$(this).attr('option-id');if(id==undefined)return;if(arrUrl[key]==undefined)arrUrl[key]={};arrUrl[key][id]=id;});var price_filter=$('.price_filter');var price_form=$('.price-link',price_filter).attr('data-form');var price_to=$('.price-link',price_filter).attr('data-to');if(price_form!=undefined&&price_to!=undefined&&(price_form!=price_filter.attr('data-min')*1||price_to!=price_filter.attr('data-max')*1)){arrUrl['price']={};price_to*=1;arrUrl['price'][price_form+'_'+price_to]=price_form+'_'+price_to;}
var queryUrl={};$.each(Object.keys(arrUrl).sort(),function(key,value){queryUrl[value]=Object.keys(arrUrl[value]).sort();});var ajaxUrl=url.getWindowUrl('?');ajaxUrl=ajaxUrl[0]+'?';var query=url.getParamUrl('q');if(query!=undefined&&query!='')ajaxUrl+='q='+query+'&';$.each(queryUrl,function(key,attrs){ajaxUrl+=key+'=';$.each(attrs,function(k,v){ajaxUrl+=v+'_';});ajaxUrl=ajaxUrl.substr(0,ajaxUrl.length-1)+'&';});ajaxUrl=ajaxUrl.substr(0,ajaxUrl.length-1);self.categoryFilter(ajaxUrl,self.options.filter);},isOpenNav:function(){return $('#products-list-filter-toggle:checked').length;},toggleSelected:function(element){var optionId=$(element).parent().attr('option-id');var attribute=$(element).closest('[data-filter]').data('filter');element=$('.item[option-id="'+optionId+'"] .multifilter_action','[data-filter="'+attribute+'"]');$('.swatch-option',element).toggleClass('selected');element.parent().toggleClass('selected');element.attr('aria-selected',element.attr('aria-selected')==='true'?false:true);var text=$.trim($(element).text());var label=$.mage.__('Label selected');if(element.parent().hasClass('selected')){$(element).attr('aria-label',text+' '+label);}else{$(element).attr('aria-label',$.mage.__('לחץ enter לבחירה')+' '+text);}},_bind:function(){var self=this;if($('.load_next',self.options.scroll.next_wrapper).hasClass('scroll')){$(window).scroll(function(){self.scrollHandler(self);});}
self.priceSlider(true);self.filterButton();self.filterInit();},scrollHandler:function(self){var next=$(self.options.scroll.next);if(self.options.isLoading||!next.length)return false;var scrollTop=$(window).height()+$(window).scrollTop();var last_item=$('.products-list').height()-scrollTop;var offset=200;if(last_item-offset<0){self.options.scroll.action='append';self.options.loading=self.options.scroll.loading_next;self.options.scroll.actionUrl=true;var next_url=next.attr('href');if(next_url==url.getWindowUrl())return false;if(next_url!=undefined){self.categoryFilter(next_url,self.options.scroll);}}},priceSlider:function(init){var self=this;var price_filter=$('.price_filter');var min_alt='';var max_alt='';if(init!=undefined||price_filter.attr('init')==undefined){price_filter.attr('init',true);var price=url.getParamUrl('price');var min=price_filter.data('min');var max=price_filter.data('max');var steps=price_filter.data('steps');var currency=window.checkout?window.checkout.currency:'₪';if(price!=undefined&&price!=''){price=price.split('_');if(price[0]>0)price[0]=price[0]++;if(price[1]>0)price[1]=price[1]--;price_filter.attr('change',true);}else{price_filter.removeAttr('change');price=[min,max];$('.price-link',price_filter).attr('data-form',min).attr('data-to',max);}
$('#price-slider',price_filter).slider({range:true,min:min,max:max,step:steps?steps:1,isRTL:false,values:[price[0],price[1]],slide:function(event,ui){var form=ui.values[0];var to=ui.values[1];$('.price_range .min',price_filter).text(currency+form);$('.price_range .max',price_filter).text(currency+to);min_alt=$(this).children()[1];max_alt=$(this).children()[2];$(min_alt).attr('aria-label',$.mage.__('מינימום')+' '+currency+form);$(max_alt).attr('aria-label',$.mage.__('מקסימום')+' '+currency+to);},change:function(event,ui){if(!event.srcElement){return;}
var form=ui.values[0];if(form!=min)form--;var to=ui.values[1];if(to!=max)to++;var price_link=$('.price-link',price_filter);price_link.attr('data-form',form).attr('data-to',to);if(form!=min||to!=max){price_filter.attr('change',true);}else{price_filter.removeAttr('change');}
self.filterApplyInit();}}).draggable();if(url.getParamUrl('price')!=undefined)
$('.price-link',price_filter).attr('data-form',$('#price-slider').slider('values',0)).attr('data-to',$('#price-slider').slider('values',1));$('.price_range .min',price_filter).text(currency+$('#price-slider').slider('values',0));$('.price_range .max',price_filter).text(currency+$('#price-slider').slider('values',1));min_alt=$('#price-slider').children()[1];max_alt=$('#price-slider').children()[2];$(min_alt).attr('aria-label',$.mage.__('מינימום')+' '+currency+$('#price-slider').slider('values',0)).attr('role','button');$(max_alt).attr('aria-label',$.mage.__('מקסימום')+' '+currency+$('#price-slider').slider('values',1)).attr('role','button');}},loader:function(status){var self=this;var loading=self.options.loading;self.options.isLoading=status;loading=$(loading);if(loading==undefined||loading.length==0){loading=$('.idus_loader_page');}
if(status==0){loading.removeClass('active');}else{loading.addClass('active');}},filterInit:function(){$('#layered-filter-block .filter-button').off('click').on('click',function(){var self=$(this);self.closest('.page-sidebar').toggleClass('open');$('#layered-filter-block').toggleClass('active');$('html').toggleClass('nav-before-open');$('body').toggleClass('filter-active');});$('body').trigger('contentUpdated');$('.items.slick-slider','.category-single-filter').slick('refresh');},categoryFilter:function(ajaxUrl,obj,element){var self=this;if(ajaxUrl==undefined||self.options.isLoading)return;self.loader(1);if(obj.action==undefined)obj.action='append';ajaxUrl=ajaxUrl.split('#')[0];ajaxUrl=url.removeParamUrl(ajaxUrl,'_');if(ajaxUrl==url.getWindowUrl()){self.loader(0);return false;}
if(obj.action=='replace')ajaxUrl=url.removeParamUrl(ajaxUrl,'p');var call_ajaxUrl=url.addParamUrl(ajaxUrl,'ajax','1');if(self.options.ajaxCall)self.options.ajaxCall.abort();self.options.ajaxCall=$.ajax({dataType:'json',method:'get',cache:true,url:call_ajaxUrl,success:function(json){ajaxUrl=url.removeParamUrl(ajaxUrl,'ajax');if(json.success==undefined||json.success!=true){window.location.replace(ajaxUrl);return;}else{if(obj.actionUrl||obj.actionUrl==undefined)
url.updateUrl(ajaxUrl);}
var products_list=$.parseHTML(json.html.products_list,null,true);if(obj.action=='replace'){if($('.product-item',products_list).length){$(obj.products_list).html($(obj.products_list,products_list).html());$('.load_prev_wrapper').html($('.load_prev_wrapper',products_list).html());$('.load_next_wrapper').html($('.load_next_wrapper',products_list).html());var filters={};var filters_obj=$.parseHTML(json.html.filters,null,true);$(self.options.filter.filter_item,filters_obj).each(function(){var code=$(this).attr('data-filter');filters[code]=$(this);var filter=$(self.options.filter.filter_item+'[data-filter='+code+']');if(filter.length){filter.show();var swatch=$('.swatch-attribute',$(this));if(swatch.length){if($('.attribute.selected',swatch).length){$('.count',filter).removeClass('hide');$(filter).addClass('has_filter');$('.count .qty',filter).text($('.attribute.selected',swatch).length);}else{$(filter).removeClass('has_filter');$('.count',filter).addClass('hide');}
filter.each(function(){if($('.slick-initialized',this).length){}else{$('.swatch-attribute',this).html(swatch.html());}});}else if($('.price_filter',$(this)).length){$('.filter-options-content',filter).html($('.filter-options-content',$(this)).html());}}else{$(this).appendTo(self.options.filter.filters).collapsible();}});$(self.options.filter.filter_item).each(function(){var code=$(this).attr('data-filter');if(filters[code]==undefined)$(this).hide();});$('.price_filter .price-link').attr('data-url',$('.price_filter .price-link',filters_obj).attr('data-url'));$('.products-list .product-items').show();$('.products-list .empty').hide();}else{$('.products-list .product-items').hide();$('.products-list .empty').show();}
self.filterInit();window.products_list=undefined;$(document).trigger('idus-layeredNavigationFilterSuccess');}else if(obj.action=='append'||obj.action=='prepend'){var products_list_html=$(obj.container,products_list);$('.product-item',products_list_html).each(function(){if($('.product-item[id="'+this.id+'"]').length){$(this).remove();}});if(obj.action=='append'){$(obj.container).append(products_list_html.html());$(obj.next_wrapper).html($(obj.next_wrapper,products_list).html());}else if(obj.action=='prepend'){$(obj.container).prepend(products_list_html.html());$(obj.prev_wrapper).html($(obj.prev_wrapper,products_list).html());}}
$('script[data-type="datalayer"]',json.html.products_list).each(function(index,element){eval(element.innerHTML);});$('[data-role=tocart-form], .form.map.checkout').mage('validation',{radioCheckboxClosest:'.nested',submitHandler:function(form){var widget=$(form).catalogAddToCart({bindSubmit:false});widget.catalogAddToCart('submitForm',$(form));return false;}});$('.count','.toolbar-products-count').text(json.html.count);self._bind();self.loader(0);self.setInitialState('filtered');$.mage.init();$('#products-list-filter-toggle').trigger('idusFilterSuccess');return true;}});window.pageLoadingAjax=self.options.ajaxCall;},_initSingleFilter:function(){var self=this;if($('.category-single-filter[data-single-filter]').length){$('.category-single-filter[data-single-filter]').each(function(i,el){var singleFilterEl=$(el);var singleFilter=singleFilterEl.data('single-filter');var layeredFilterEl=$('.products-list-filter .filter-options-item[data-filter="'+singleFilter+'"]');if(!layeredFilterEl.length){layeredFilterEl=$('.products-list-filter .items[attribute-code="'+singleFilter+'"]');if(layeredFilterEl.length)layeredFilterEl=layeredFilterEl.parent();}
if(layeredFilterEl.length){singleFilterEl.html(layeredFilterEl.clone());$('.items .item',singleFilterEl).addClass('cloned');layeredFilterEl.addClass('hasSingleFilterClone');if(singleFilterEl.data('is-slider')){var slidesToShowPC=singleFilterEl.data('slides-to-show-pc');var slidesToShowTB=singleFilterEl.data('slides-to-show-tb');var slidesToShowSP=singleFilterEl.data('slides-to-show-sp');$('.items',singleFilterEl).slick({direction:"rtl",rtl:true,focusOnSelect:false,infinite:true,lazyLoad:"progressive",autoplay:false,autoplaySpeed:false,fade:false,dots:true,arrows:true,slidesToShow:slidesToShowPC,slidesToScroll:slidesToShowPC,responsive:[{breakpoint:1199,settings:{slidesToShow:slidesToShowTB,slidesToScroll:slidesToShowTB}},{breakpoint:767,settings:{slidesToShow:slidesToShowSP,slidesToScroll:slidesToShowSP}}]});}}});}},setSelectDymaicWidth:function(select){var $this=$(select);var style=window.getComputedStyle(select);var text=$this.find("option:selected").text();var $test=$("<span>").html(text).css({"font-size":style.fontSize,"font-weight":style.fontWeight,"font-family":style.fontFamily,"visibility":"hidden"});$test.appendTo($this.parent());var width=$test.width();$test.remove();$this.width(width).addClass('width-set');}});return $.idus.categoryFilter;});